/*! examinr 0.1.0
 *! Original work (c) 2019 RStudio | License: Apache 2.0
 *! Modified work (c) 2020-2020 David Kepplinger | License: MIT + file LICENSE */

"use strict";window.Exam=function(){var a={};return a.shim=function(){return{toggle:function(a,b){a=a?$(a):$("body");var c=a.children(".examinr-recompute-overlay");if(void 0===b&&(b=0===c.length),!1===b)c.remove(),a.removeClass("examinr-recompute-outer");else{c=$('<div class="examinr-recompute-overlay"><div class="examinr-recompute"></div></div>'),a.prepend(c);var d=c.offsetParent();d.length>0&&d.get(0)!==a.get(0)&&a.addClass("examinr-recompute-outer"),a.show()}}}}(),a.aria=function(){function a(a){return a||(a="aria-el-"),a+Math.random().toString(36).slice(2)}function b(b){if(b.attr("id"))return b.attr("id");var c=a();return b.attr("id",c),c}function c(a,c,d){var e=b(d);c.attr("aria-"+a,e)}return{randomId:a,associate:c,labelledBy:function(a,b){c("labelledby",a,b)},describedBy:function(a,b){c("describedby",a,b)}}}(),a.status=function(){function b(){h&&h.length>0&&$("body").css("paddingTop",h.height())}function c(){var a=$(this),b=parseInt(a.text());b&&!isNaN(b)?a.text(new Date(1e3*b).toLocaleString()):a.text("")}function d(b,d,e,f,g,h,i){var j=n.children("button");l.html(b).find(".examinr-timestamp").each(c),m.html(d).find(".examinr-timestamp").each(c),"none"===e?n.hide():(j.text(f),"reload"===e?j.one("click",function(){window.location.reload()}):"trigger"===e&&g&&h&&j.one("click",function(){i?(a.shim.toggle($("body"),!0),window.setTimeout(function(){return $("#"+g).trigger(h)},i)):$("#"+g).trigger(h)})),a.shim.toggle($("body"),!1),o.attr("role","none"===e?"dialog":"errordialog").appendTo(document.body).one("hidden.bs.modal",function(){o.detach()}).modal({keyboard:!1,backdrop:"static",show:!0})}function e(a){return a>=10?a.toString(10):"0"+a.toString(10)}function f(){var a=k===Number.POSITIVE_INFINITY?Number.POSITIVE_INFINITY:k-new Date,b=p.find(".examinr-timer");if(!isNaN(a)&&a<Number.POSITIVE_INFINITY)if(a<1&&a>-1e3*(j.gracePeriod||1)&&(a=0),a>=0){var c=Math.floor(a/36e5),h=Math.floor(a%36e5/6e4),l=Math.floor(a%6e4/1e3);c>0?b.children(".hrs").removeClass("ignore").text(e(c)):b.children(".hrs").addClass("ignore").text("00"),b.children(".min").text(e(h)),c>0||h>=10?(b.children(".min").addClass("nosec"),b.children(".sec").hide()):(b.children(".min").removeClass("nosec"),b.children(".sec").show().text(e(l))),b.show(),c>0||h>=12?g=window.setTimeout(f,6e4):(p.hasClass("alert")&&(h<5?p.removeClass("alert-warning").addClass("alert-danger"):h<10&&p.removeClass("alert-info").addClass("alert-warning")),g=window.setTimeout(f,1e3))}else $(".main-container").remove(),d(i.attemptTimeout.title,i.attemptTimeout.body,"none");else b.hide()}var g,h,i={},j={},k=Number.POSITIVE_INFINITY,l=$('<h4 class="modal-title" id="'+a.aria.randomId("examinr-status-dialog-title-")+'">'),m=$('<div class="modal-body" id="'+a.aria.randomId("examinr-status-dialog-body-")+'">'),n=$('<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal">Close</button></div>'),o=$('<div class="modal" tabindex="-1" role="alertdialog" aria-labelledby="'+l.attr("id")+'"aria-describedby="'+m.attr("id")+'"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"></div></div></div></div>'),p=$('<div class="alert alert-info examinr-progress" role="status"></div>'),q=$('<div class="alert alert-info lead examinr-status-message" role="alert"></div>');return o.find(".modal-header").append(l),o.find(".modal-content").append(m).append(n),Shiny.addCustomMessageHandler("__.examinr.__-statusMessage",function(a){if(q.detach(),"error"===a.type)d(a.content.title,a.content.body,a.action,a.content.button,a.triggerId,a.triggerEvent,a.triggerDelay);else if("locked"===a.type)d(a.content.title,a.content.body,"none",""),$(".main-container").hide();else{var e="warning"===a.type?"alert-warning":"alert-info";q.removeClass("alert-warning alert-info").addClass(e),q.html(a.content.body).find(".examinr-timestamp").each(c)}b()}),Shiny.addCustomMessageHandler("__.examinr.__-attemptStatus",function(a){if(a.gracePeriod&&(j.gracePeriod=a.gracePeriod),a&&a.active){$(".main-container").show().trigger("shown"),p.show(),0===a.timelimit||a.timelimit&&"Inf"!==a.timelimit||(a.timelimit=Number.POSITIVE_INFINITY);try{k=new Date(1e3*a.timelimit),g&&(window.clearTimeout(g),g=!1),f()}catch(a){window.console.warn("Cannot set timelimit for current attempt:",a),k=Number.POSITIVE_INFINITY}}else $(".main-container").hide(),p.hide()}),$(function(){if(a.shim.toggle($("body"),!0),h=$(".examinr-exam-status"),h.length>0&&(h.prependTo(document.body),j=JSON.parse(h.children("script.status-config").remove().text()||"{}"),i=JSON.parse(h.children("script.status-messages").remove().text()||"{}"),i.progress)){var c=i.progress.section.replace("{section_nr}",'<span class="examinr-section-nr">1</span>').replace("{total_sections}",'<span class="examinr-total-sections">'+(j.totalSections||1)+"</span>"),d=i.progress.timer.replace("{time_left}",'<span class="examinr-timer" role="timer"><span class="hrs">??</span><span class="min">??</span><span class="sec"></span></span>');j.progressive||j.haveTimelimit?(j.progressive&&j.haveTimelimit?p.html(i.progress.combined.replace("{section}",c).replace("{timer}",d)):j.progressive?p.html(c):j.haveTimelimit&&p.html(d),h.append(p),f()):p.hide()}if(j.progressbar){var e=$('<div class="progress"><div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="'+j.totalSections+'" style="min-width: 2em;"></div></div>');h.addClass("examinr-with-progressbar").append(e)}b()}),{resetMessages:function(){q.detach(),o.detach(),b()},getMessage:function(a){return i[a]||null},updateProgress:function(a){(!a||isNaN(a)||a<0||a>j.totalSections)&&(a=j.totalSections),p.show().find(".examinr-section-nr").text(a),j.progressbar&&p.find(".progress-bar").attr("aria-valuenow",a).width(Math.round(100*a/j.totalSections)+"%"),b()}}}(),a.questions=function(){function b(a){a.preventDefault()}function c(){$("input[type=number]").on("focus",function(){$(this).on("wheel.disableScrollEvent",b).on("keydown.disableScrollEvent",function(a){a.which!==f&&a.which!==e||a.preventDefault()})}).on("blur",function(){$(this).off(".disableScrollEvent")})}function d(){$(".examinr-question").each(function(){var b=$(this);b.find(".hide-label .control-label").addClass("sr-only"),a.aria.labelledBy(b,b.find(".panel-title"))})}var e=38,f=40;return $(function(){d(),c()}),{}}(),a.exercises=function(){function b(a,b){var c=ace.edit(a);return c.setHighlightActiveLine(!1),c.setShowPrintMargin(!1),c.setShowFoldWidgets(!1),c.setBehavioursEnabled(!0),c.renderer.setDisplayIndentGuides(!1),c.setTheme("ace/theme/textmate"),c.$blockScrolling=1/0,c.session.setMode("ace/mode/r"),c.session.getSelection().clearSelection(),c.setValue(b,-1),c}function c(b,c){void 0===c&&(c=!h),a.shim.toggle(b,c),h=!1===c,$(".examinr-run-button").prop("disabled",!h)}function d(){$(".examinr-exercise").each(function(){var c=$(this),d=JSON.parse(c.children('script[type="application/json"]').detach().text()||"{}"),e="";c.children("pre").each(function(){e+=$(this).children("code").text()+"\n"}).remove();var h=e.split(/\r?\n/).length,i=d.lines?Math.max(1,d.lines):Math.min(Math.max(f,h),g);h<i&&(e+="\n".repeat(i-h));var j=d.inputId+"-editor",k=d.points?'<span class="label '+(d.labelClass||"")+'">'+d.points+"</span>":"",l=a.status.getMessage("exercise")||{},m=$('<div class="panel '+(d.panelClass||"")+'"><div class="panel-heading"><button type="button" class="btn '+(d.buttonClass||"")+' btn-xs examinr-run-button pull-right"><span class="glyphicon glyphicon-play" aria-hidden="true"></span>'+d.buttonLabel+'</button><h5 class="panel-title">'+(d.title||"")+k+'</h5></div><div class="panel-body"><div id="'+j+'" class="examinr-exercise-editor" role="textbox" contenteditable="true" aria-multiline="true" tabindex=0 ></div></div><div class="panel-footer"><div class="small alert alert-warning examinr-exercise-status" role="log">'+l.notYetRun+"</div></div></div>"),n=$('<div class="examinr-exercise-output well" role="status"></div>'),o=c.find("#"+j);c.append(m).append(n),a.aria.labelledBy(c,m.find(".panel-title")),a.aria.associate("controls",m.find(".examinr-run-button"),n),o.attr("aria-label",d.inputLabel),o.children().attr("aria-hidden","true"),l.notYetRun?a.aria.describedBy(m,c.find(".examinr-exercise-status")):c.find(".examinr-exercise-status").hide(),c.find(".examinr-exercise-output").hide();var p=c.find(".examinr-run-button"),q=function(){p.click()},r=b(j,e);r.setFontSize(.8125*parseFloat(c.find(".panel-body").css("font-size"))),r.commands.addCommand({name:"run_rcode",bindKey:{win:"Ctrl+Enter",mac:"Command+Enter"},exec:q}),r.commands.addCommand({name:"run_rcode-shift",bindKey:{win:"Ctrl+Shift+Enter",mac:"Command+Shift+Enter"},exec:q});var s=function(){r.setOptions({minLines:i,maxLines:i})};s(),r.getSession().on("change",s),p.click(function(){r.focus()}),c.data({editor:r,options:d}),c.parents("section").on("shown",function(){r.resize(!0)})})}function e(){var a=new Shiny.InputBinding;$.extend(a,{find:function(a){return $(a).find(".examinr-exercise")},getId:function(a){return $(a).data("options").inputId},subscribe:function(a,b){a=$(a),a.find(".examinr-run-button").on("click.examinrExerciseInputBinding",function(){h&&(a.data("sendData",!0),c(a.find(".examinr-exercise-output"),!0),b(!0))})},unsubscribe:function(a){$(a).find(".examinr-run-button").off(".examinrExerciseInputBinding")},getValue:function(a){return a=$(a),!0!==a.data("sendData")?null:(a.data("sendData",!1),{label:a.data("options").label,code:a.data("editor").getSession().getValue(),timestamp:(new Date).getTime()})},setValue:function(a,b){$(a).data("editor").getSession().setValue(b)}}),Shiny.inputBindings.register(a,"examinr.exerciseInputBinding");var b=new Shiny.OutputBinding;$.extend(b,{find:function(a){return $(a).find(".examinr-exercise")},getId:function(a){return $(a).data("options").outputId},renderValue:function(a,b){a=$(a),b.result?a.find(".examinr-exercise-output").show().html(b.result):a.find(".examinr-exercise-output").hide().html(""),b.status?(a.find(".examinr-exercise-status").removeClass("alert-success").removeClass("alert-info").removeClass("alert-warning").removeClass("alert-danger").addClass("alert-"+(b.status_class||"info")),a.find(".examinr-exercise-status").show().html(b.status)):a.find(".examinr-exercise-status").hide().html(""),c(a.find(".examinr-exercise-output"),!1)},renderError:function(a,b){a=$(a),c(a.find(".examinr-exercise-output"),!1),a.find(".examinr-exercise-output").hide(),a.find(".examinr-exercise-status").show().text(b.message)},clearError:function(a){a=$(a),c(a.find(".examinr-exercise-output"),!1),a.find(".examinr-exercise-output").hide(),a.find(".examinr-exercise-status").hide()}}),Shiny.outputBindings.register(b,"examinr.exerciseOutputBinding")}var f=5,g=20,h=!0;return $(function(){d(),e()}),{}}(),a.autocomplete=function(){function a(a){return g|(a.ctrlKey?h:0)|(a.altKey?i:0)|(a.metaKey?k:0)|(a.shiftKey?j:0)}function b(a){return a.completer&&a.completer.popup&&a.completer.popup.isOpen}function c(a,c,d,e,f){var g=c.getTextRange({start:{row:0,column:0},end:d}),h=b(a)?"value":"event";n=f,Shiny.setInputValue("__.examinr.__-autocomplete",{code:g,label:a.exerciseLabel},{priority:h})}function d(){var a=$(this);if(!0===a.data("options").autocomplete){var d=a.data("editor"),g=a.data("options"),h=function(){d.execCommand("startAutocomplete")},i=function(a){if(clearTimeout(f),a=a||{},"insert"===a.action&&a.lines&&a.lines.length&&!(a.lines.length>1)){var c=d.getCursorPosition(),e=d.session.getLine(c.row);if(!b(d)||/::$/.test(e)){var g=/[$@]$|::$/.test(e)?10:300;f=setTimeout(h,g)}}};d.on("change",i),d.on("destroy",function(){d.off(i)}),d.exerciseLabel=g.label,d.completers=d.completers||[],d.completers.push({getCompletions:c}),d.setOptions({enableBasicAutocompletion:!0,enableLiveAutocompletion:!1}),d.keyBinding.addKeyboardHandler({handleKeyboard:e})}}function e(c,d,e,i,j){if(-1!==d&&c.editor){var k=a(j);if(i===m&&k===h||i===l&&k===g&&(!c.editor.completer||!c.editor.completer.activated))return clearTimeout(f),b(c.editor)?(c.editor.completer.popup.hide(),{command:"null"}):{command:"startAutocomplete"}}}var f,g=0,h=1,i=2,j=4,k=8,l=9,m=32,n=function(){},o={insertMatch:function(a,b){for(var c=a.selection.getAllRanges(),d=a.completer.completions.filterText.length,e=0;e<c.length;e++)c[e].start.column-=d,a.session.remove(c[e]);a.execCommand("insertstring",b.caption),b.is_function&&a.navigateLeft(1)}};return Shiny.addCustomMessageHandler("__.examinr.__-autocomplete",function(a){var b=a.map(function(a){return a&&a[1]?{caption:a[1]+(a[2]?"()":""),value:a[1],score:0,meta:a[0]?"{"+a[0]+"}":"",is_function:a[2],completer:o}:null}).filter(function(a){return a});n(null,b)}),$(function(){$(".examinr-exercise").each(d)}),{}}(),a.sections=function(){function b(){a.shim.toggle($("body"),!1)}var c,d=250,e={},f={};return Shiny.addCustomMessageHandler("__.examinr.__-sectionChange",function(e){if(e.current){c&&c.removeAttr("role").hide(),f=e.current,c=$("#"+f.ui_id).parent().show().attr("role","main").trigger("shown");var g=c.find(".shiny-bound-output"),h=g.length;if(h>0){var i=window.setTimeout(b,d);g.one("shiny:recalculated",function(){--h,h<=0?b():(window.clearTimeout(i),i=window.setTimeout(b,d))})}else b();a.status.resetMessages(),e.current.order&&a.status.updateProgress(e.current.order)}}),$(function(){var b=$("#examinr-sections-options");if(b.length>0&&(e=JSON.parse(b.text()),b.remove()),$("section.level1").each(function(){var b=$(this);a.aria.labelledBy(b,b.children("h1"))}),$("#section-header").attr("aria-hidden","true"),e.progressive)$("section.level1").hide(),$(".examinr-section-next").click(function(){a.shim.toggle($("body"),!0)});else{$(".examinr-section-next").hide();var c=$(".main-container");c.attr("role","main"),a.aria.labelledBy(c,$("h1.title")),$("section.level1").last().find(".examinr-section-next").show()}}),{}}(),{}}();
//# sourceMappingURL=exam.min.js.map